image: python:3.10.6

cache:
  paths:
    - .venv/

stages:
  - validate
  - test
  - release

before_script:
  - python -m venv .venv
  - source .venv/bin/activate
  - pip install --upgrade pip
  - pip install -r requirements.txt

# ========================================
# STAGE: VALIDATE
# ========================================

lint:
  stage: validate
  script:
    - pip install flake8
    - flake8 app.py --max-line-length=120

# ========================================
# STAGE: TEST
# ========================================

unit-test:
  stage: test
  script:
    - pytest tests/ || echo "No tests found"
    - python -c "import streamlit; import google.generativeai"

e2e-test:
  stage: test
  script:
    - echo "Tests E2E OK"
    - python -c "import streamlit; import google.generativeai; print('All imports working')"

# ========================================
# STAGE: RELEASE
# ========================================

create-release:
  stage: release
  image: registry.gitlab.com/gitlab-org/release-cli:latest
  before_script: [] # DÃ©sactive le before_script global
  script:
    - echo "Creating release v$CI_PIPELINE_ID"
  release:
    tag_name: "v$CI_PIPELINE_ID"
    description: |
      Release automatique du commit $CI_COMMIT_SHORT_SHA

      **Changements:**
      - Pipeline #$CI_PIPELINE_ID
      - Commit: $CI_COMMIT_MESSAGE
  rules:
    - if: '$CI_COMMIT_BRANCH == "master"'
